---
title: Androidå‰å°æœåŠ¡ - Foreground Service
catalog: true
date: 2020-08-02 01:27:48
subtitle:
header-img: head.jpg
tags: Android
---

# æ¦‚è¿°
æœ¬æ–‡å°†å›é¡¾`æœåŠ¡`çš„ç›¸å…³çŸ¥è¯†å’Œä½¿ç”¨æ¡ˆä¾‹ï¼Œä»¥åŠå¦‚ä½•éšè—ç”±å‰å°æœåŠ¡åˆ›å»ºçš„é€šçŸ¥æ 
<div align="center">
    <img src="summary.jpg" width="80%" />
</div>

# æœåŠ¡
`Service`æ˜¯ä¸€ç§å¯åœ¨åå°`é•¿æ—¶é—´è¿è¡Œ`çš„`æ— ç•Œé¢`åº”ç”¨ç»„ä»¶ã€‚
<div align="center">
    <img src="service_lifecycle.png" width="80%" title="Serviceç”Ÿå‘½å‘¨æœŸ" />
</div>

## æœåŠ¡çš„ç§ç±»
æŒ‰ç…§è¿è¡Œç°è±¡ï¼Œå¯ä»¥å°†æœåŠ¡åˆ†ä¸ºå‰å°æœåŠ¡å’Œåå°æœåŠ¡ï¼›æŒ‰ç…§å¯åŠ¨æ–¹å¼ï¼Œåˆå¯ä»¥å°†æœåŠ¡åˆ†ä¸ºå¯åŠ¨æœåŠ¡å’Œç»‘å®šæœåŠ¡ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼Œä¸€ä¸ªæœåŠ¡ç±»æ—¢å¯ä»¥æ”¯æŒå¯åŠ¨æœåŠ¡ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æ”¯æŒç»‘å®šï¼Œåªè¦å®ç°ç›¸åº”çš„å›è°ƒæ–¹æ³•å³å¯ï¼š`onStartCommand()`ï¼ˆå¯åŠ¨æœåŠ¡ï¼‰å’Œ`onBind()`ï¼ˆç»‘å®šæœåŠ¡ï¼‰ã€‚

## æœåŠ¡çš„ç‰¹å¾
1. æœåŠ¡åœ¨åº”ç”¨è¿›ç¨‹çš„`ä¸»çº¿ç¨‹æ‰§è¡Œ`ï¼Œå¯åŠ¨æˆ–ç»‘å®šæœåŠ¡å¹¶ä¸ä¼šåˆ›å»ºè‡ªå·±çš„çº¿ç¨‹ï¼Œä¹Ÿä¸ä¼šåœ¨å•ç‹¬çš„è¿›ç¨‹ä¸­æ‰§è¡Œï¼ˆé™¤éå¦è¡ŒæŒ‡å®šï¼‰ã€‚å› æ­¤ï¼Œè€—æ—¶æ“ä½œåº”å½“åœ¨æœåŠ¡ä¸­åˆ›å»ºæ–°çš„çº¿ç¨‹æ¥å®Œæˆï¼Œå¦åˆ™å®¹æ˜“ANR
2. å¯åŠ¨æœåŠ¡ä¸€æ—¦å¯åŠ¨ï¼Œå°±ä¼š`æ— é™æœŸè¿è¡Œ`ï¼Œç›´åˆ°å…¶è°ƒç”¨`stopSelf()`è‡ªè¡Œåœæ­¢æˆ–å…¶ä»–ç»„ä»¶è°ƒç”¨`stopServicec()`å°†å…¶åœæ­¢
3. åœ¨ç³»ç»Ÿèµ„æºä¸è¶³æ—¶ï¼Œç³»ç»Ÿä¼šæ ¹æ®ä¼˜å…ˆçº§ä¸»åŠ¨åœæ­¢æœåŠ¡ã€‚å…¶ä¸­`å‰å°æœåŠ¡`æ‹¥æœ‰è¾ƒé«˜ä¼˜å…ˆçº§ï¼Œä¸€èˆ¬ä¸ä¼šè¢«åœæ­¢ï¼Œè€Œ`åå°æœåŠ¡`çš„ä¼˜å…ˆçº§åˆ™ä¸è¿è¡Œæ—¶é—´æœ‰å…³ï¼Œé•¿æ—¶é—´è¿è¡Œçš„æœåŠ¡è¢«åœæ­¢çš„æ¦‚ç‡æ›´é«˜ã€‚åŒæ—¶ï¼Œå¦‚æœæœåŠ¡æ˜¯ç”±äºèµ„æºä¸è¶³è€Œè¢«ç³»ç»Ÿåœæ­¢ï¼Œé‚£ä¹ˆåœ¨ç³»ç»Ÿèµ„æºæ»¡è¶³çš„æƒ…å†µä¸‹ï¼ŒæœåŠ¡å°†è¢«ç³»ç»Ÿé‡å¯
4. `stopSelf()`å’Œ`stopServicec()`å¹¶ä¸æ˜¯å°†æœåŠ¡ç«‹å³ç»“æŸï¼Œä»…æ˜¯é€šçŸ¥ç³»ç»Ÿå°½å¿«é”€æ¯è€Œå·²

## æœåŠ¡åŸºç±»
è‡ªå®šä¹‰æœåŠ¡å¯ä»¥ç»§æ‰¿ä»¥ä¸‹ä¸¤ä¸ªåŸºç±»
### Service
é€‚ç”¨äºæ‰€æœ‰æœåŠ¡ã€‚ç»§æ‰¿è¯¥åŸºç±»æ—¶ï¼ŒæœåŠ¡ä¸­çš„ä¸šåŠ¡æ“ä½œå¿…é¡»åˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œï¼Œå› ä¸ºæœåŠ¡é»˜è®¤ä½¿ç”¨åº”ç”¨çš„ä¸»çº¿ç¨‹ï¼Œè¿™ä¼šé™ä½åº”ç”¨æ­£åœ¨è¿è¡Œçš„Activityçš„æ€§èƒ½ç”šè‡³å¯¼è‡´ANR
### IntentServiceï¼ˆğŸ‘è‡ªAPI 30å·²åºŸå¼ƒï¼‰
ç»§æ‰¿è¯¥åŸºç±»æ—¶ï¼ŒæœåŠ¡ä¼šè‡ªåŠ¨åˆ›å»ºçº¿ç¨‹æ¥å¤„ç†æ¯ä¸€ä¸ªåˆ°æ¥çš„Intentï¼Œä¸”ä¼šåœ¨å¤„ç†å®Œæ‰€æœ‰Intentåè‡ªåŠ¨åœæ­¢æœåŠ¡ï¼Œè€Œæ— éœ€ä½¿ç”¨è€…æ‰‹åŠ¨è°ƒç”¨`stopSelf()`ã€‚
å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè‡ªå®šä¹‰æœåŠ¡æ—¶ä¸åº”é‡å†™`onStartCommand()`æ–¹æ³•ï¼Œå¦åˆ™å¯èƒ½ä¼šå¯¼è‡´`onHandleIntent()`æ— æ³•æ­£å¸¸å“åº”

## å‰å°æœåŠ¡
è‡ªAndroid 8.0ï¼ˆAPI 26ï¼‰å¼€å§‹ï¼ŒAndroidç³»ç»Ÿå¼€å§‹æ‰§è¡Œä¸¥æ ¼çš„[åå°æ‰§è¡Œé™åˆ¶](https://developer.android.com/about/versions/oreo/background)ï¼Œåå°åº”ç”¨ä¸å…è®¸é»˜é»˜å¯åŠ¨åå°æœåŠ¡ï¼Œåªèƒ½å¯åŠ¨å‰å°æœåŠ¡ï¼Œè€Œå‰å°åº”ç”¨åˆ™å¯ä»¥è‡ªç”±åˆ›å»ºå‰å°æœåŠ¡å’Œåå°æœåŠ¡ã€‚åº”ç”¨è¿›å…¥åå°æ—¶ï¼Œæœ‰ä¸€ä¸ªæŒç»­æ•°åˆ†é’Ÿçš„çª—å£æœŸï¼Œåœ¨çª—å£æœŸå†…ä»ç„¶å¯ä»¥åˆ›å»ºå’Œä½¿ç”¨å‰å°/åå°Serviceã€‚çª—å£æœŸç»“æŸåï¼Œåº”ç”¨è¢«è§†ä¸ºå¤„äºç©ºé—²çŠ¶æ€ï¼Œç³»ç»Ÿå°†åœæ­¢åº”ç”¨çš„åå°Serviceï¼Œå°±åƒæœåŠ¡è°ƒç”¨äº†è‡ªå·±çš„`stopSelf()`æ–¹æ³•ä¸€æ ·ã€‚
### åå°åº”ç”¨çš„å®šä¹‰
ä½•ä¸ºåå°åº”ç”¨ï¼ŸğŸ¤”
>å¦‚æœæ»¡è¶³ä»¥ä¸‹ä»»æ„æ¡ä»¶ï¼Œåº”ç”¨å°†è¢«è§†ä¸ºå¤„äºå‰å°ï¼š
>- å…·æœ‰å¯è§ Activityï¼ˆä¸ç®¡è¯¥ Activity å·²å¯åŠ¨è¿˜æ˜¯å·²æš‚åœï¼‰
>- å…·æœ‰å‰å° Service
>- å¦ä¸€ä¸ªå‰å°åº”ç”¨å·²å…³è”åˆ°è¯¥åº”ç”¨ï¼ˆä¸ç®¡æ˜¯é€šè¿‡ç»‘å®šåˆ°å…¶ä¸­ä¸€ä¸ª Serviceï¼Œè¿˜æ˜¯é€šè¿‡ä½¿ç”¨å…¶ä¸­ä¸€ä¸ªå†…å®¹æä¾›ç¨‹åºï¼‰ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå¦ä¸€ä¸ªåº”ç”¨ç»‘å®šåˆ°è¯¥åº”ç”¨çš„ Serviceï¼Œé‚£ä¹ˆè¯¥åº”ç”¨å¤„äºå‰å°ï¼š
>   - IME
>   - å£çº¸ Service
>   - é€šçŸ¥ä¾¦å¬å™¨
>   - è¯­éŸ³æˆ–æ–‡æœ¬ Service
>
>å¦‚æœä»¥ä¸Šæ¡ä»¶å‡ä¸æ»¡è¶³ï¼Œåº”ç”¨å°†è¢«è§†ä¸ºå¤„äºåå°ã€‚
### å‰å°æœåŠ¡çš„å¯åŠ¨
å‰å°æœåŠ¡ä¸€èˆ¬éœ€è¦å…ˆé€šè¿‡`startForegroundService()`å¯åŠ¨ä¸€ä¸ªåå°æœåŠ¡ï¼ŒåŒæ—¶è¯¥æ–¹æ³•å‘ç³»ç»Ÿå‘é€ä¿¡å·ï¼Œè¡¨æ˜æœåŠ¡å°†ä¼šè‡ªè¡Œæå‡å‰å°ã€‚å¯åŠ¨æœåŠ¡åï¼Œè¯¥æœåŠ¡éœ€è¦åœ¨`äº”ç§’å†…`è°ƒç”¨è‡ªå·±çš„`startForeground()`æ–¹æ³•æ˜¾å¼æå‡æœåŠ¡è‡³å‰å°ã€‚è€Œæ­£æ˜¯è¿™ä¸ª`startForeground()`æ–¹æ³•ï¼Œå”¤èµ·äº†æœ¬æ–‡å¼€å¤´çš„é‚£ä¸ªçƒ¦äººçš„ç³»ç»Ÿé€šçŸ¥ã€‚

### å‰å°æœåŠ¡ä¸é€šçŸ¥æ 

# æ¡ˆä¾‹

# éšè—å‰å°æœåŠ¡é€šçŸ¥æ 

# å‚è€ƒèµ„æ–™
1. [æœåŠ¡æ¦‚è§ˆ](https://developer.android.com/guide/components/services)
2. [åå°æ‰§è¡Œé™åˆ¶](https://developer.android.com/about/versions/oreo/background)
3. [IntentService](https://developer.android.com/reference/android/app/IntentService)
